set-option -g history-limit 25000
set -g mouse on

# change prefix from C-b to C-Space
unbind C-b
set -g prefix C-Space
bind C-Space send-prefix

# for neovim
set -sg escape-time 10
set-option -g focus-events on


# vi for copy mode
setw -g mode-keys vi

# status bar
set -g status-right "#(pomo)"
set -g status-style "fg=#665c54"
set -g status-left-style "fg=#928374"

set -g status-bg default
set -g status-position top
set -g status-interval 1
set -g status-left ""

# disable status
# set -g status off
# set -g status on

# apply shared theme (syncs with Alacritty/Nvim toggle script)
run-shell "~/.config/theme/apply-tmux.sh"

# count the panes from 1
set -g base-index 1
setw -g pane-base-index 1

# reload configuration
bind-key -r r source-file ~/.tmux.conf

# term colors, these are the correct ones according to neovim checkhealth
set-option -g default-terminal "screen-256color"

# ===== NESTED TMUX SESSION SUPPORT =====
# Toggle nested mode with F12 (standard practice)
# When enabled, local tmux passes all keys to inner/remote tmux
# Visual feedback: status bar dims when in nested mode

# Enter nested mode: F12
# Disables all local bindings, dims status bar, shows [NESTED] indicator
bind -n F12 \
  set prefix None \;\
  set key-table off \;\
  set status-style "fg=#504945,bg=#1d2021" \;\
  set status-left "#[fg=#fb4934,bg=#1d2021,bold] NESTED #[default] " \;\
  set window-status-current-style "fg=#504945,bg=#1d2021" \;\
  set window-status-current-format "#[fg=#504945,bg=#1d2021] #I:#W* " \;\
  if -F '#{pane_in_mode}' 'send-keys -X cancel' \;\
  refresh-client -S \;\
  display-message "NESTED MODE: Press F12 to exit"

# Exit nested mode: F12 (while in nested mode)
# Restores all local bindings and status bar
bind -T off F12 \
  set -u prefix \;\
  set -u key-table \;\
  set -u status-style \;\
  set status-left "" \;\
  set -u window-status-current-style \;\
  set -u window-status-current-format \;\
  refresh-client -S \;\
  display-message "LOCAL MODE: Controlling outer tmux"

# When in nested mode (off table), C-Space switches to nested-prefix table
# This allows sending commands to the inner tmux
bind -T off C-Space switch-client -T nested-prefix

# Nested prefix table: these commands send C-Space + key to inner tmux
# Most common commands for inner tmux control
bind -T nested-prefix C-Space send-keys C-Space C-Space  # Send literal C-Space to inner
bind -T nested-prefix c send-keys C-Space c               # New window
bind -T nested-prefix d send-keys C-Space d               # Detach
bind -T nested-prefix p send-keys C-Space p               # Previous window
bind -T nested-prefix n send-keys C-Space n               # Next window (note: this conflicts with exit nested mode)
bind -T nested-prefix 0 send-keys C-Space 0               # Window 0
bind -T nested-prefix 1 send-keys C-Space 1               # Window 1
bind -T nested-prefix 2 send-keys C-Space 2               # Window 2
bind -T nested-prefix 3 send-keys C-Space 3               # Window 3
bind -T nested-prefix 4 send-keys C-Space 4               # Window 4
bind -T nested-prefix 5 send-keys C-Space 5               # Window 5
bind -T nested-prefix 6 send-keys C-Space 6               # Window 6
bind -T nested-prefix 7 send-keys C-Space 7               # Window 7
bind -T nested-prefix 8 send-keys C-Space 8               # Window 8
bind -T nested-prefix 9 send-keys C-Space 9               # Window 9
bind -T nested-prefix h send-keys C-Space h               # Split horizontal
bind -T nested-prefix v send-keys C-Space v               # Split vertical
bind -T nested-prefix j send-keys C-Space j               # Pane down
bind -T nested-prefix k send-keys C-Space k               # Pane up
bind -T nested-prefix l send-keys C-Space l               # Pane right
bind -T nested-prefix x send-keys C-Space x               # Kill pane
bind -T nested-prefix [ send-keys C-Space [               # Copy mode
bind -T nested-prefix ] send-keys C-Space ]               # Paste
