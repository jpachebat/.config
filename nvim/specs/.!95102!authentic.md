# Gmail OAuth Authentication Integration

## Problem Overview

### Current Authentication Architecture

The Himalaya email client uses a multi-layered authentication system:

1. **Gmail OAuth2 Tokens**: Access tokens (short-lived) and refresh tokens (long-lived)
2. **mbsync Integration**: External sync tool that requires valid OAuth tokens
3. **Systemd Automation**: Background service that refreshes tokens automatically
4. **Environment Dependencies**: OAuth client ID required for token refresh operations

### Issues Encountered

#### 1. **Token Expiration Cascade**
- Gmail OAuth access tokens expire regularly (typically every hour)
- When tokens expire, both mbsync and manual sync operations fail
- User sees generic "Mail sync failed" errors without clear indication of cause

#### 2. **Environment Variable Isolation**
- `GMAIL_CLIENT_ID` set in user shell (`private.fish`) 
- Systemd services run in isolated environment without shell variables
- Background token refresh fails with "invalid_client" error
- Manual refresh works (shell context) but automatic refresh fails (systemd context)

#### 3. **Multi-Method Sync Complexity**
